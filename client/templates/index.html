<!DOCTYPE html>
<html>
<head>
    <title>NFC Client</title>
    <meta charset="UTF-8">
</head>
<body>
    <h1>NFC Client</h1>
    <p><a href="/register">Registrieren</a></p>
    
    <h2>Scanner Status</h2>
    <p>{{ nfc_status }}</p>
    
    {% if result and result.result %}
    <h2>Scan Ergebnis</h2>
    <p><strong>{{ result.result.message }}</strong></p>
    <p>Tag: {{ result.nfc_tag }}</p>
    <p>Zeit: {{ result.timestamp }}</p>
    
    {% if result.result.action_needed == 'register' %}
        <p><a href="/register">Registrieren</a></p>
    {% elif result.result.action_needed == 'pin_setup' %}
        <h3>PIN erstellen</h3>
        <div>
            <label>Neue PIN (4 Ziffern):</label><br>
            <input type="password" id="new-pin" placeholder="0000" maxlength="4" style="font-size: 18px; padding: 5px; margin: 5px;">
        </div>
        <div>
            <label>PIN best채tigen:</label><br>
            <input type="password" id="confirm-pin" placeholder="0000" maxlength="4" style="font-size: 18px; padding: 5px; margin: 5px;">
        </div>
        <button onclick="setupPin()" style="font-size: 16px; padding: 10px; margin: 5px;">PIN erstellen</button>
    {% elif result.result.action_needed == 'pin_login' %}
        <h3>Anmelden</h3>
        <div>
            <label>PIN eingeben:</label><br>
            <input type="password" id="login-pin" placeholder="0000" maxlength="4" style="font-size: 18px; padding: 5px; margin: 5px;">
        </div>
        <button onclick="loginPin()" style="font-size: 16px; padding: 10px; margin: 5px;">Anmelden</button>
    {% endif %}
    {% endif %}

    <script>
        let currentNfcTag = '{{ result.nfc_tag if result else "" }}';
        let lastKnownTag = currentNfcTag;
        
        // Verhindere Neuladen wenn bereits ein NFC-Tag angezeigt wird und Benutzer interagiert
        let userInteracting = false;
        
        // Erkenne Benutzerinteraktion
        document.addEventListener('focus', function(event) {
            if (event.target.matches('input[type="password"]')) {
                userInteracting = true;
                console.log('User ist am PIN eingeben - stoppe Auto-Reload');
            }
        }, true);
        
        document.addEventListener('blur', function(event) {
            if (event.target.matches('input[type="password"]')) {
                setTimeout(() => {
                    userInteracting = false;
                    console.log('User hat PIN-Eingabe verlassen - Auto-Reload wieder aktiv');
                }, 5000); // 5 Sekunden Puffer
            }
        }, true);
        
        setInterval(() => {
            // Nur neu laden wenn Benutzer nicht gerade PIN eingibt
            if (!userInteracting) {
                fetch('/api/last-scan').then(r => r.json()).then(data => {
                    if (data.nfc_tag && data.nfc_tag !== lastKnownTag) {
                        console.log('Neuer NFC-Tag erkannt, lade Seite neu');
                        location.reload();
                    }
                });
            }
        }, 1000);

        function setupPin() {
            const pin = document.getElementById('new-pin').value;
            const confirm = document.getElementById('confirm-pin').value;
            
            if (!pin || pin.length !== 4) {
                alert('PIN muss genau 4 Ziffern haben');
                return;
            }
            
            if (pin !== confirm) {
                alert('PINs stimmen nicht 체berein');
                return;
            }
            
            userInteracting = true; // Verhindere Auto-Reload w채hrend der Anfrage
            
            fetch('/api/nfc/signup', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({nfc_tag: currentNfcTag, pin: pin, pin_confirm: confirm})
            }).then(r => r.json()).then(data => {
                alert(data.message);
                if (data.success) {
                    setTimeout(() => location.reload(), 1000);
                } else {
                    userInteracting = false; // Erlaube Auto-Reload wieder bei Fehlern
                }
            }).catch(error => {
                alert('Fehler bei PIN-Erstellung: ' + error.message);
                userInteracting = false;
            });
        }

            function loginPin() {
    const pin = document.getElementById('login-pin').value;
    
    if (!pin || pin.length !== 4) {
        alert('PIN muss genau 4 Ziffern haben');
        return;
    }
    
    userInteracting = true;
    
    fetch('/api/nfc/signin', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({nfc_tag: currentNfcTag, pin: pin})
    }).then(r => r.json()).then(data => {
        if (data.success) {
            // Hier kannst du die UID verwenden!
            alert(data.message + "\nUID: " + data.user_id);

            // Beispiel: Weiterleitung auf eine Willkommensseite mit UID
            window.location.href = "/welcome/" + data.user_id + "/";

            // Oder: Starte eine Session, zeige weitere Infos, etc.
            // startSession(data.user_id);

            // setTimeout(() => location.reload(), 1000); // Nur falls du die Seite neu laden willst
        } else {
            alert(data.message);
            userInteracting = false;
        }
    }).catch(error => {
        alert('Fehler bei Anmeldung: ' + error.message);
        userInteracting = false;
    });
}
        // Enter-Taste Unterst체tzung
        document.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                if (document.getElementById('new-pin') && document.activeElement.id.includes('pin')) {
                    setupPin();
                } else if (document.getElementById('login-pin') && document.activeElement.id === 'login-pin') {
                    loginPin();
                }
            }
        });
    </script>
</body>
</html>
