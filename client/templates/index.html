<!DOCTYPE html>
<html>
<head>
    <title>NFC Client Web UI</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>ğŸ”– NFC Client Web Interface</h1>
        
        <div class="navigation">
            <a href="/register" class="nav-link">ğŸ†• NFC-Tag registrieren</a>
        </div>
        
        <div class="nfc-scanner">
            <h3>ğŸ”– NFC Scanner</h3>
            <p>Lege einen NFC-Tag auf den Arduino-Scanner auf...</p>
            <div class="scanner-status">
                {% if nfc_status == 'ğŸ“¡ Aktiv und bereit' %}
                    <div class="scanner-active">
                        <div class="pulse"></div>
                        <strong>Scanner bereit - Warte auf Tag...</strong>
                    </div>
                {% else %}
                    <div class="scanner-inactive">
                        <strong>{{ nfc_status }}</strong>
                    </div>
                {% endif %}
            </div>
        </div>

        {% if result and result.result %}
        <div class="result {{ 'success' if result.result.status != 'error' else 'error' }}">
            <h3>ğŸ“¡ NFC-Scan Ergebnis</h3>
            <p><strong>{{ result.result.message }}</strong></p>
            <small>Gescannt um: {{ result.timestamp }}</small>
            
            <div class="nfc-info">
                <div class="nfc-detail">
                    <strong>Tag ID:</strong><br>
                    <code>{{ result.nfc_tag }}</code>
                </div>
                <div class="nfc-detail">
                    <strong>Status:</strong><br>
                    {% if result.result.status == 'not_registered' %}
                        âŒ Nicht registriert
                    {% elif result.result.status == 'needs_pin_setup' %}
                        ğŸ”“ PIN erforderlich
                    {% elif result.result.status == 'needs_login' %}
                        ğŸ” Anmeldung erforderlich
                    {% else %}
                        âš ï¸ {{ result.result.status }}
                    {% endif %}
                </div>
                <div class="nfc-detail">
                    <strong>Aktion:</strong><br>
                    {% if result.result.action_needed == 'register' %}
                        <button onclick="redirectToRegister('{{ result.nfc_tag }}')">ğŸ†• Registrieren</button>
                    {% elif result.result.action_needed == 'pin_setup' %}
                        <button onclick="showPinSetup('{{ result.nfc_tag }}')">ğŸ” PIN erstellen</button>
                    {% elif result.result.action_needed == 'pin_login' %}
                        <button onclick="showPinLogin('{{ result.nfc_tag }}')">ğŸ”‘ Anmelden</button>
                    {% else %}
                        Keine weitere Aktion erforderlich
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- PIN-Aktionen Modal -->
        <div id="pin-actions" class="modal" style="display: none;">
            <div class="modal-content">
                <h3 id="pin-action-title">PIN-Aktion</h3>
                
                <!-- PIN Setup -->
                <div id="pin-setup" style="display: none;">
                    <div class="form-group">
                        <label for="new-pin">Neue 4-stellige PIN:</label>
                        <input type="password" id="new-pin" placeholder="0000" maxlength="4" pattern="[0-9]{4}">
                    </div>
                    <div class="form-group">
                        <label for="confirm-pin">PIN bestÃ¤tigen:</label>
                        <input type="password" id="confirm-pin" placeholder="0000" maxlength="4" pattern="[0-9]{4}">
                    </div>
                    <button onclick="setupPin()" class="btn-primary">PIN erstellen</button>
                </div>
                
                <!-- PIN Login -->
                <div id="pin-login" style="display: none;">
                    <div class="form-group">
                        <label for="login-pin">Ihre 4-stellige PIN:</label>
                        <input type="password" id="login-pin" placeholder="0000" maxlength="4" pattern="[0-9]{4}">
                    </div>
                    <button onclick="loginPin()" class="btn-primary">Anmelden</button>
                </div>
                
                <button onclick="cancelPinAction()" class="btn-secondary">Abbrechen</button>
            </div>
        </div>

        <div class="status">
            <h4>ğŸ“¡ Client Status</h4>
            <p><strong>Arduino Serial Port:</strong> {{ arduino_status }}</p>
            <p><strong>NFC Scanner:</strong> {{ nfc_status }}</p>
            <p><strong>Server Verbindung:</strong> Bereit</p>
        </div>
    </div>

    <script>
        let currentNfcTag = null;

        function showPinSetup(nfcTag) {
            currentNfcTag = nfcTag;
            document.getElementById('pin-actions').style.display = 'block';
            document.getElementById('pin-action-title').textContent = `PIN fÃ¼r Tag ${nfcTag} erstellen`;
            document.getElementById('pin-setup').style.display = 'block';
            document.getElementById('pin-login').style.display = 'none';
            document.getElementById('new-pin').focus();
        }

        function showPinLogin(nfcTag) {
            currentNfcTag = nfcTag;
            document.getElementById('pin-actions').style.display = 'block';
            document.getElementById('pin-action-title').textContent = `Anmelden mit Tag ${nfcTag}`;
            document.getElementById('pin-setup').style.display = 'none';
            document.getElementById('pin-login').style.display = 'block';
            document.getElementById('login-pin').focus();
        }

        function setupPin() {
            const pin = document.getElementById('new-pin').value;
            const confirmPin = document.getElementById('confirm-pin').value;
            
            if (pin.length !== 4 || !pin.match(/^\d{4}$/)) {
                alert('PIN muss genau 4 Ziffern haben!');
                return;
            }
            
            if (pin !== confirmPin) {
                alert('PINs stimmen nicht Ã¼berein!');
                return;
            }
            
            console.log('ğŸ” Sending PIN setup request:', {nfc_tag: currentNfcTag, pin: pin});
            
            fetch('/api/nfc/signup', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    nfc_tag: currentNfcTag,
                    pin: pin,
                    pin_confirm: confirmPin
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('ğŸ“¤ PIN setup response:', data);
                alert(data.message);
                if (data.success) {
                    // Aktion erfolgreich - entferne Tag aus UI
                    clearCurrentScanResult();
                    cancelPinAction();
                } else {
                    // Fehler - behalte Tag in UI fÃ¼r erneuten Versuch
                    console.log('PIN setup failed, keeping tag visible');
                }
            })
            .catch(error => {
                console.error('âŒ PIN setup error:', error);
                alert('Fehler bei der Kommunikation: ' + error);
            });
        }

        function loginPin() {
            const pin = document.getElementById('login-pin').value;
            
            if (pin.length !== 4 || !pin.match(/^\d{4}$/)) {
                alert('PIN muss genau 4 Ziffern haben!');
                return;
            }
            
            fetch('/api/nfc/signin', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    nfc_tag: currentNfcTag,
                    pin: pin
                })
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                if (data.success) {
                    // Login erfolgreich - entferne Tag aus UI
                    clearCurrentScanResult();
                    cancelPinAction();
                } else {
                    // Login fehlgeschlagen - behalte Tag fÃ¼r erneuten Versuch
                    console.log('Login failed, keeping tag visible');
                }
            })
            .catch(error => {
                alert('Fehler bei der Kommunikation: ' + error);
            });
        }

        function cancelPinAction() {
            document.getElementById('pin-actions').style.display = 'none';
            document.getElementById('new-pin').value = '';
            document.getElementById('confirm-pin').value = '';
            document.getElementById('login-pin').value = '';
            currentNfcTag = null;
        }

        function clearCurrentScanResult() {
            // Entferne das aktuelle Scan-Ergebnis aus der UI
            const resultDiv = document.querySelector('.result');
            if (resultDiv) {
                resultDiv.style.display = 'none';
                setTimeout(() => {
                    resultDiv.remove();
                }, 300);
            }
            
            // Setze Timestamp zurÃ¼ck damit neue Scans wieder angezeigt werden
            lastKnownTimestamp = '';
            
            console.log('âœ… Scan result cleared from UI');
        }

        function redirectToRegister(nfcTag) {
            // Speichere Tag-ID fÃ¼r Registrierungsseite
            sessionStorage.setItem('pendingNfcTag', nfcTag);
            window.location.href = '/register';
        }

        let lastKnownTimestamp = '{{ result.timestamp if result else "" }}';
        
        // Auto-refresh fÃ¼r neue Scan-Ergebnisse
        setInterval(() => {
            fetch('/api/last-scan')
            .then(response => response.json())
            .then(data => {
                console.log('ğŸ”„ Checking for new scans:', data);
                if (data && data.nfc_tag && data.timestamp !== lastKnownTimestamp) {
                    console.log('ğŸ†• New scan detected! Reloading...');
                    lastKnownTimestamp = data.timestamp;
                    location.reload();
                    // Nach dem Reload zur Ergebnis-Sektion scrollen
                    setTimeout(() => {
                        const resultElement = document.querySelector('.result');
                        if (resultElement) {
                            resultElement.scrollIntoView({ 
                                behavior: 'smooth',
                                block: 'center'
                            });
                        }
                    }, 100);
                } else {
                    console.log('â³ No new scans');
                }
            })
            .catch(error => console.log('âŒ Refresh check failed:', error));
        }, 1000); // HÃ¤ufigere Checks fÃ¼r schnellere Reaktion
    </script>
</body>
</html>