<!DOCTYPE html>
<html>
<head>
    <title>NFC Client - Registrierung</title>
    <meta charset="UTF-8">
</head>
<body>
    <h1>NFC-Tag Registrierung</h1>
    <p><a href="/">← Zurück</a></p>
    
    <form id="register-form">
        <div>
            <label for="nfc_tag">NFC-Tag ID:</label>
            <input type="text" id="nfc_tag" name="nfc_tag" required placeholder="Bitte NFC-Tag scannen...">
        </div>
        
        <div>
            <label for="vorname">Vorname:</label>
            <input type="text" id="vorname" name="vorname" required>
        </div>
        
        <div>
            <label for="nachname">Nachname:</label>
            <input type="text" id="nachname" name="nachname" required>
        </div>
        
        <button type="submit">Registrieren</button>
    </form>
    
    <div id="message"></div>

    <script>
        // WebSocket-Verbindung für automatisches NFC-Tag einfügen
        let ws;
        
        function connectWebSocket() {
            try {
                ws = new WebSocket('ws://localhost:5000/socket.io/?transport=websocket');
                
                ws.onopen = function(event) {
                    console.log('WebSocket verbunden');
                };
                
                ws.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    if (data.type === 'nfc_scanned' && data.tag_id) {
                        document.getElementById('nfc_tag').value = data.tag_id;
                        console.log('NFC-Tag automatisch eingefügt:', data.tag_id);
                    }
                };
                
                ws.onclose = function(event) {
                    console.log('WebSocket getrennt, versuche Reconnect in 3s...');
                    setTimeout(connectWebSocket, 3000);
                };
                
                ws.onerror = function(error) {
                    console.log('WebSocket Fehler:', error);
                };
            } catch (error) {
                console.log('WebSocket Verbindung fehlgeschlagen, versuche erneut in 3s...');
                setTimeout(connectWebSocket, 3000);
            }
        }
        
        // Starte WebSocket-Verbindung beim Laden der Seite
        window.addEventListener('load', connectWebSocket);
        
        // Polling-Alternative falls WebSocket nicht funktioniert
        let lastTagCheck = '';
        setInterval(async () => {
            try {
                const response = await fetch('/api/nfc/last_scanned');
                const data = await response.json();
                if (data.success && data.tag_id && data.tag_id !== lastTagCheck) {
                    document.getElementById('nfc_tag').value = data.tag_id;
                    lastTagCheck = data.tag_id;
                    console.log('NFC-Tag via Polling eingefügt:', data.tag_id);
                }
            } catch (error) {
                // Ignoriere Polling-Fehler
            }
        }, 1000);
        
        document.getElementById('register-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            
            const formData = {
                nfc_tag: document.getElementById('nfc_tag').value,
                name: document.getElementById('vorname').value,
                surname: document.getElementById('nachname').value,
            };
            
            try {
                const response = await fetch('/api/nfc/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                const messageDiv = document.getElementById('message');
                
                if (data.success) {
                    messageDiv.innerHTML = `<div style="color: green;">${data.message}</div>`;
                    document.getElementById('register-form').reset();
                    lastTagCheck = ''; // Reset für nächsten Scan
                } else {
                    messageDiv.innerHTML = `<div style="color: red;">${data.message}</div>`;
                }
            } catch (error) {
                const messageDiv = document.getElementById('message');
                messageDiv.innerHTML = `<div style="color: red;">Fehler beim Registrieren: ${error.message}</div>`;
            }
        });
    </script>
</body>
</html>